name: tests # runs unit and integration tests

on:
  push:
    branches-ignore: [main]
  workflow_dispatch:

jobs:
  linux-tests:
    strategy:
      matrix:
        node: [20, 22]
      fail-fast: false
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node }}
          cache: npm
      - run: yarn install
      - name: Cache node modules
        id: cache-nodemodules
        uses: actions/cache@v3
        env:
          cache-name: cache-node-modules
        with:
          path: "**/node_modules"
          key: ${{ runner.os }}-node${{ matrix.node }}-build-${{ env.cache-name }}-${{ hashFiles('yarn.lock') }}
        if: ${{ steps.cache-nodemodules.outputs.cache-hit != 'true' }}
      - run: yarn run renderTemplates
      - run: yarn build:lib
      - name: Log bundle sizes
        run: |
          echo "::group::Bundle sizes for lib/ directory"
          echo "Individual file sizes:"
          ls -lh lib/*.js | awk '{printf "  %-50s %10s\n", $9, $5}'
          echo ""
          echo "Summary by file type:"
          echo "  ESM files:"
          du -ch lib/*.js | grep -v '\.cjs\.js' | tail -1 | awk '{printf "    Total: %s\n", $1}'
          echo "  CJS files:"
          du -ch lib/*.cjs.js 2>/dev/null | tail -1 | awk '{printf "    Total: %s\n", $1}' || echo "    Total: 0"
          echo ""
          echo "Total lib/ directory size:"
          du -sh lib | awk '{printf "  %s\n", $1}'
          echo "::endgroup::"
      - run: yarn test
